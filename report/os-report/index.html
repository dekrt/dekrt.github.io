<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>操作系统实验报告&amp;课程设计 | dekrt's blog</title><meta name="keywords" content="报告 | report"><meta name="author" content="dekrt"><meta name="copyright" content="dekrt"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="软件学院操作系统原理实验报告与课程设计">
<meta property="og:type" content="article">
<meta property="og:title" content="操作系统实验报告&amp;课程设计">
<meta property="og:url" content="https://dekrt.cn/report/os-report/index.html">
<meta property="og:site_name" content="dekrt&#39;s blog">
<meta property="og:description" content="软件学院操作系统原理实验报告与课程设计">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2023/07/26/pCjs4a9.jpg">
<meta property="article:published_time" content="2023-07-12T03:43:44.000Z">
<meta property="article:modified_time" content="2023-10-12T02:26:02.776Z">
<meta property="article:author" content="dekrt">
<meta property="article:tag" content="报告 | report">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2023/07/26/pCjs4a9.jpg"><link rel="shortcut icon" href="https://s1.ax1x.com/2023/04/14/ppzvSxK.jpg"><link rel="canonical" href="https://dekrt.cn/report/os-report/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '操作系统实验报告&课程设计',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-12 10:26:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="dekrt's blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s1.ax1x.com/2023/04/14/ppzvSxK.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s1.ax1x.com/2023/07/26/pCjs4a9.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">dekrt's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">操作系统实验报告&amp;课程设计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-12T03:43:44.000Z" title="发表于 2023-07-12 11:43:44">2023-07-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-12T02:26:02.776Z" title="更新于 2023-10-12 10:26:02">2023-10-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/report/">report</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>46分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="操作系统实验报告&amp;课程设计"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/report/os-report/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/report/os-report/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>报告仓库：<a target="_blank" rel="noopener" href="https://github.com/dekrt/Reports">dekrt/Reports:
HUST SSE Courses Reports | 华科软件学院课程报告 (github.com)</a></p>
</blockquote>
<h1 align="center">
《操作系统原理》实验报告(一)
</h1>
<table style="width:100%;">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 18%">
<col style="width: 7%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">姓名</th>
<th style="text-align: center;">dekrt</th>
<th style="text-align: center;">学号</th>
<th style="text-align: center;">U2021172??</th>
<th style="text-align: center;">专业班级</th>
<th style="text-align: center;">软件2102班</th>
<th style="text-align: center;">时间</th>
<th style="text-align: center;">2023.03.13</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<h2 id="一实验目的">一、实验目的</h2>
<p>1）理解操作系统引导程序/BIOS/MBR的概念和作用；</p>
<p>2）理解并应用操作系统生成的概念和过程；</p>
<p>3）理解并应用操作系统操作界面，系统调用概念</p>
<p>4）掌握和推广国产操作系统（推荐银河麒麟或优麒麟，建议）</p>
<h2 id="二实验内容">二、实验内容</h2>
<p>1）用NASM编写MBR引导程序，在BOCHS虚拟机中测试。</p>
<p>2）在Linux（建议Ubuntu或银河麒麟或优麒麟）下裁剪和编译Linux内核，并启用
新内核。（其他发行版本也可以）</p>
<p>3）为Linux内核（建议Ubuntu或银河麒麟或优麒麟）增加2个系统调用，并启用
新的内核，并编写应用程序测试。（其他发行版本也可以）</p>
<p>4）在Linux （建议Ubuntu或银河麒麟或优麒麟） 或Windows下，编写脚本或批
处理。脚本参数1个：指定目录。脚本的作用是把指定目录中的全部文件的文件名
加后缀，后缀是执行脚本时的日期和时分。例如：文件名“test”变成“test2023-03-14-20-42”</p>
<h2 id="三实验环境和核心代码">三、实验环境和核心代码</h2>
<h3 id="用nasm编写mbr引导程序">3.1 用NASM编写MBR引导程序</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.67，编辑工具：vim &amp;
gedit</p>
</blockquote>
<p>首先，安装bochs、bochs和nasm</p>
<p>安装 bochs 、bocshs与 nasm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bochs</span><br><span class="line">sudo apt-get install bochs-x</span><br><span class="line">sudo apt-get install nasm</span><br></pre></td></tr></table></figure>
<p>编写 <code>boot.asm</code> ,命令如图</p>
<figure>
<img src="/report/os-report/image-20230712115144181.png" alt="image-20230712115144181">
<figcaption aria-hidden="true">image-20230712115144181</figcaption>
</figure>
<p>文件内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">	org	07c00h</span><br><span class="line">	mov	ax, cs</span><br><span class="line">	mov	ds, ax</span><br><span class="line">	mov	es, ax</span><br><span class="line">	call	DispStr</span><br><span class="line">	jmp	$</span><br><span class="line">DispStr:</span><br><span class="line">	mov	ax, BootMessage</span><br><span class="line">	mov	bp, ax</span><br><span class="line">	mov	cx, 16</span><br><span class="line">	mov	ax, 01301h</span><br><span class="line">	mov	bx, 000ch</span><br><span class="line">	mov	dl, 0</span><br><span class="line">	int	10h</span><br><span class="line">	ret</span><br><span class="line">BootMessage:		db	&quot;Hello, OS world!&quot;</span><br><span class="line">times	510-($-$$)	db	0</span><br><span class="line">dw	0xaa55</span><br></pre></td></tr></table></figure>
<p>编译<code>boot.asm</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nasm boot.asm -o boot.bins</span><br></pre></td></tr></table></figure>
<p>创建镜像文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bximage</span><br></pre></td></tr></table></figure>
<p>进行如下操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">========================================================================</span><br><span class="line">                                bximage</span><br><span class="line">  Disk Image Creation / Conversion / Resize and Commit Tool for Bochs</span><br><span class="line">         $Id: bximage.cc 14091 2021-01-30 17:37:42Z sshwarts $</span><br><span class="line">========================================================================</span><br><span class="line"></span><br><span class="line">1. Create new floppy or hard disk image</span><br><span class="line">2. Convert hard disk image to other format (mode)</span><br><span class="line">3. Resize hard disk image</span><br><span class="line">4. Commit &#x27;undoable&#x27; redolog to base image</span><br><span class="line">5. Disk image info</span><br><span class="line"></span><br><span class="line">0. Quit</span><br><span class="line"></span><br><span class="line">Please choose one [0] 1</span><br><span class="line"></span><br><span class="line">Create image</span><br><span class="line"></span><br><span class="line">Do you want to create a floppy disk image or a hard disk image?</span><br><span class="line">Please type hd or fd. [hd] fd</span><br><span class="line"></span><br><span class="line">Choose the size of floppy disk image to create.</span><br><span class="line">Please type 160k, 180k, 320k, 360k, 720k, 1.2M, 1.44M, 1.68M, 1.72M, or 2.88M.</span><br><span class="line"> [1.44M] </span><br><span class="line"></span><br><span class="line">What should be the name of the image?</span><br><span class="line">[a.img] </span><br><span class="line"></span><br><span class="line">Creating floppy image &#x27;a.img&#x27; with 2880 sectors</span><br><span class="line"></span><br><span class="line">The following line should appear in your bochsrc:</span><br><span class="line">  floppya: image=&quot;a.img&quot;, status=inserted</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将程序加载到镜像文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=boot.bins of=a.img bs=512 count=1 conv=notrunc</span><br></pre></td></tr></table></figure>
<p>编写 bochs 配置文件 <code>bochsrs</code></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">megs:<span class="number">32</span></span><br><span class="line">romimage: <span class="keyword">file</span>=<span class="regexp">/usr/</span>share<span class="regexp">/bochs/</span>BIOS-bochs-latest</span><br><span class="line">vgaromimage: <span class="keyword">file</span>=<span class="regexp">/usr/</span>share<span class="regexp">/bochs/</span>VGABIOS-lgpl-latest</span><br><span class="line"></span><br><span class="line">floppya : <span class="number">1</span>_44=a.img, status=inserted</span><br><span class="line">boot : floppy</span><br><span class="line">log : bochsout.txt</span><br><span class="line">mouse : enabled=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>使用配置启动 bochs</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bochs -f bochsrc</span></span><br></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">========================================================================</span><br><span class="line">                        <span class="keyword">Bochs </span>x86 Emulator <span class="number">2</span>.<span class="number">7</span></span><br><span class="line">              <span class="keyword">Built </span>from SVN snapshot on August  <span class="number">1</span>, <span class="number">2021</span></span><br><span class="line"><span class="symbol">                Timestamp:</span> Sun Aug  <span class="number">1</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">00</span> CEST <span class="number">2021</span></span><br><span class="line">========================================================================</span><br><span class="line"><span class="number">00000000000</span>i[      ] <span class="keyword">BXSHARE </span>not set. using compile time default <span class="string">&#x27;/usr/share/bochs&#x27;</span></span><br><span class="line"><span class="number">00000000000</span>i[      ] reading configuration from <span class="keyword">bochsrc</span></span><br><span class="line"><span class="keyword"></span>------------------------------</span><br><span class="line"><span class="keyword">Bochs </span>Configuration: Main Menu</span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line">This is the <span class="keyword">Bochs </span>Configuration Interface, where you can describe the</span><br><span class="line">machine that you want to simulate.  <span class="keyword">Bochs </span>has already searched for a</span><br><span class="line">configuration file (typically called <span class="keyword">bochsrc.txt) </span><span class="keyword">and </span>loaded it if it</span><br><span class="line">could <span class="keyword">be </span>found.  When you are satisfied with the configuration, go</span><br><span class="line">ahead <span class="keyword">and </span>start the simulation.</span><br><span class="line"></span><br><span class="line">You can also start <span class="keyword">bochs </span>with the -q option to skip these menus.</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. Restore factory default configuration</span><br><span class="line"><span class="number">2</span>. Read options from...</span><br><span class="line"><span class="number">3</span>. Edit options</span><br><span class="line"><span class="number">4</span>. Save options to...</span><br><span class="line"><span class="number">5</span>. Restore the <span class="keyword">Bochs </span>state from...</span><br><span class="line"><span class="number">6</span>. <span class="keyword">Begin </span>simulation</span><br><span class="line"><span class="number">7</span>. Quit now</span><br><span class="line"></span><br><span class="line">Please choose one: [<span class="number">6</span>] <span class="number">6</span></span><br><span class="line"><span class="number">00000000000</span>i[      ] <span class="keyword">installing </span>x module as the <span class="keyword">Bochs </span>GUI</span><br><span class="line"><span class="number">00000000000</span>i[      ] using log file <span class="keyword">bochsout.txt</span></span><br><span class="line"><span class="keyword"></span>Next <span class="built_in">at</span> t=<span class="number">0</span></span><br><span class="line">(<span class="number">0</span>) [<span class="number">0x0000fffffff0</span>] f000:fff0 (unk. ctxt): <span class="keyword">jmpf </span><span class="number">0xf000</span>:e<span class="symbol">05b</span>          <span class="comment">; ea5be000f0</span></span><br><span class="line">&lt;<span class="keyword">bochs:1&gt; </span><span class="keyword">b </span><span class="number">0x7c00</span></span><br><span class="line">&lt;<span class="keyword">bochs:2&gt; </span>c</span><br><span class="line">(<span class="number">0</span>) <span class="keyword">Breakpoint </span><span class="number">1</span>, <span class="number">0x0000000000007c00</span> in ?? ()</span><br><span class="line">Next <span class="built_in">at</span> t=<span class="number">14034560</span></span><br><span class="line">(<span class="number">0</span>) [<span class="number">0x000000007c00</span>] <span class="number">0000</span>:<span class="number">7</span>c00 (unk. ctxt): mov ax, cs                <span class="comment">; 8cc8</span></span><br><span class="line">&lt;<span class="keyword">bochs:3&gt; </span>n</span><br><span class="line">Next <span class="built_in">at</span> t=<span class="number">14034561</span></span><br><span class="line">(<span class="number">0</span>) [<span class="number">0x000000007c02</span>] <span class="number">0000</span>:<span class="number">7</span>c02 (unk. ctxt): mov ds, ax                <span class="comment">; 8ed8</span></span><br><span class="line">&lt;<span class="keyword">bochs:4&gt; </span>n</span><br><span class="line">Next <span class="built_in">at</span> t=<span class="number">14034562</span></span><br><span class="line">(<span class="number">0</span>) [<span class="number">0x000000007c04</span>] <span class="number">0000</span>:<span class="number">7</span>c04 (unk. ctxt): mov es, ax                <span class="comment">; 8ec0</span></span><br><span class="line">&lt;<span class="keyword">bochs:5&gt; </span>n</span><br><span class="line">Next <span class="built_in">at</span> t=<span class="number">14034563</span></span><br><span class="line">(<span class="number">0</span>) [<span class="number">0x000000007c06</span>] <span class="number">0000</span>:<span class="number">7</span>c06 (unk. ctxt): call .+<span class="number">2</span>  (<span class="number">0x00007c0b</span>)    <span class="comment">; e80200</span></span><br><span class="line">&lt;<span class="keyword">bochs:6&gt; </span>n</span><br><span class="line">Next <span class="built_in">at</span> t=<span class="number">14041965</span></span><br><span class="line">(<span class="number">0</span>) [<span class="number">0x000000007c09</span>] <span class="number">0000</span>:<span class="number">7</span>c09 (unk. ctxt): <span class="keyword">jmp </span>.-<span class="number">2</span>  (<span class="number">0x00007c09</span>)     <span class="comment">; ebfe</span></span><br><span class="line">&lt;<span class="keyword">bochs:7&gt; </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>依次输入直至窗口出现 <code>Hello, OS world!</code> 字样</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">b 0x7c00</span><br><span class="line">c</span><br><span class="line">n</span><br><span class="line">n</span><br><span class="line">n</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115223329.png" alt="image-20230712115223329">
<figcaption aria-hidden="true">image-20230712115223329</figcaption>
</figure>
<figure>
<img src="/report/os-report/image-20230712115234417.png" alt="image-20230712115234417">
<figcaption aria-hidden="true">image-20230712115234417</figcaption>
</figure>
<h3 id="裁剪并编译linux内核">3.2 裁剪并编译linux内核</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.67，编辑工具：vim &amp;
gedit</p>
</blockquote>
<p>首先，前往 kernel.org
下载版本相近且高于运行版本的内核，本实验中选择5.15.100。下载完后将其解压至根目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo tar -xvJf linux-5.15.100.tar.xz /usr/src</span></span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115240778.png" alt="image-20230712115240778">
<figcaption aria-hidden="true">image-20230712115240778</figcaption>
</figure>
<p>使用apt-get命令安装依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install gcc gdb bison flex</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install libncurses5-dev libssl-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install libidn11-dev libidn11</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install zlibc minizip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install build-essential openssl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install libelf-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install dwarves</span></span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115246500.png" alt="image-20230712115246500">
<figcaption aria-hidden="true">image-20230712115246500</figcaption>
</figure>
<p>然后进行更新：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br></pre></td></tr></table></figure>
<p>进入到解压的文件目录下，依次运行这三条命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo make mrproper <span class="comment">#清除残留的.config和.o文件</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make clean</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make menuconfig <span class="comment">#打开配置内核的图形窗口</span></span></span><br></pre></td></tr></table></figure>
<p>在menuconfig界面，依次选择save &amp; exit</p>
<figure>
<img src="/report/os-report/image-20230712115255174.png" alt="image-20230712115255174">
<figcaption aria-hidden="true">image-20230712115255174</figcaption>
</figure>
<p>退出后，为了防止在编译内核时报如下错误：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make[<span class="number">1</span>]: *** 没有规则可制作目标“debian/canonical-revoked-certs.pem”，由“certs/x509_revocation_list” 需求。 停止。</span><br><span class="line">make[<span class="number">1</span>]: *** 正在等待未完成的任务....</span><br><span class="line">make: *** [<span class="symbol">Makefile</span>:<span class="number">1868</span>：certs] 错误 <span class="number">2</span></span><br><span class="line">make: *** 正在等待未完成的任务....</span><br></pre></td></tr></table></figure>
<p>我们要修改config文件：使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo gedit .config</span></span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115302106.png" alt="image-20230712115302106">
<figcaption aria-hidden="true">image-20230712115302106</figcaption>
</figure>
<p>将.config文件中的</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_SYSTEM_TRUSTED_KEYS</span>=<span class="string">&quot;debian/canonical-certs.pem&quot;</span></span><br><span class="line"><span class="attr">CONFIG_SYSTEM_REVOCATION_KEYS</span>=<span class="string">&quot;debian/canonical-revoked-certs.pem&quot;</span></span><br></pre></td></tr></table></figure>
<p>修改为</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_SYSTEM_TRUSTED_KEYS</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">CONFIG_SYSTEM_REVOCATION_KEYS</span>=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>使用以下命令编译内核：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo su</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -j16 2&gt;err.log</span></span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115309404.png" alt="image-20230712115309404">
<figcaption aria-hidden="true">image-20230712115309404</figcaption>
</figure>
<p>其中，<code>2&gt;err.log</code>是将错误信息重定向到<code>err.log</code>文件中，便于在编译过程中排查错误；<code>-j16</code>可利用多线程提高编译速度（我的CPU是八核），过程十分漫长</p>
<figure>
<img src="/report/os-report/image-20230712115314437.png" alt="image-20230712115314437">
<figcaption aria-hidden="true">image-20230712115314437</figcaption>
</figure>
<p>编译完成后会提示<code>kernel is ready</code></p>
<figure>
<img src="/report/os-report/image-20230712115319964.png" alt="image-20230712115319964">
<figcaption aria-hidden="true">image-20230712115319964</figcaption>
</figure>
<p>依次使用下列命令进行模块安装、内核安装、更新grub：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo make modules_install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo update-grub2</span></span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115324506.png" alt="image-20230712115324506">
<figcaption aria-hidden="true">image-20230712115324506</figcaption>
</figure>
<p>完成后重启，可以在ubuntu高级选项中看到编译成功的内核，加载成功后使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure>
<p>查看当前内核版本</p>
<figure>
<img src="/report/os-report/image-20230712115329423.png" alt="image-20230712115329423">
<figcaption aria-hidden="true">image-20230712115329423</figcaption>
</figure>
<h3 id="为linux内核增添系统调用">3.3 为linux内核增添系统调用</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.67，编辑工具：vim &amp;
gedit</p>
</blockquote>
<p>在<code>/usr/src/linux-5.15.100/arch/x86/entry/syscalls</code>目录，使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit syscall_64.tbl</span><br></pre></td></tr></table></figure>
<p>在在547后面添加系统调用号548和549，分别为add函数和max函数的调用</p>
<figure>
<img src="/report/os-report/image-20230712115339047.png" alt="image-20230712115339047">
<figcaption aria-hidden="true">image-20230712115339047</figcaption>
</figure>
<p>随后，使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/linux-5.15.100/arch/x86/include/asm</span><br><span class="line">vim syscalls.h</span><br></pre></td></tr></table></figure>
<p>添加两个函数声明（注意使用<code>long</code>！！！）</p>
<figure>
<img src="/report/os-report/image-20230712115345190.png" alt="image-20230712115345190">
<figcaption aria-hidden="true">image-20230712115345190</figcaption>
</figure>
<p>然后，使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /use/src/linux-5.15.100/kernel</span><br><span class="line">vim sys.c</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者使用下列命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo gedit sys.c</span></span><br></pre></td></tr></table></figure>
<p>添加两个函数的定义</p>
<figure>
<img src="/report/os-report/image-20230712115349982.png" alt="image-20230712115349982">
<figcaption aria-hidden="true">image-20230712115349982</figcaption>
</figure>
<p>然后，进行内核的编译：</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/linux-5.15.100/</span><br><span class="line">sudo make menuconfig</span><br></pre></td></tr></table></figure></p>
<p>选择save &amp;
exit，同实验二中修改<code>.config</code>文件，使用下列命令进行编译、加载：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line"><span class="keyword">make</span> -j16 <span class="number">2</span>&gt;err.<span class="built_in">log</span></span><br><span class="line"><span class="keyword">make</span> modules_install</span><br><span class="line"><span class="keyword">make</span> insatll</span><br></pre></td></tr></table></figure>
<p>在ubuntu高级选项中看到编译成功的内核，加载之，进入桌面，使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch test.c</span><br><span class="line">vim test.c</span><br></pre></td></tr></table></figure>
<p>输入测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nRet;</span><br><span class="line">    nRet = syscall(<span class="number">548</span>, <span class="number">20</span>, <span class="number">18</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, nRet);</span><br><span class="line">    nRet = syscall(<span class="number">549</span>, <span class="number">20</span>, <span class="number">18</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, nRet);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用<code>:wq!</code>保存退出，使用gcc编译运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o run</span><br><span class="line">./run</span><br></pre></td></tr></table></figure>
<p>查看输出，与预期结果一致。</p>
<figure>
<img src="/report/os-report/image-20230712115406697.png" alt="image-20230712115406697">
<figcaption aria-hidden="true">image-20230712115406697</figcaption>
</figure>
<h3 id="在linux下编写shell文件">3.4 在linux下编写shell文件</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.67，编辑工具：vim &amp;
gedit</p>
</blockquote>
<p>在终端中输入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch task4.sh</span><br><span class="line">vim  task4.sh</span><br></pre></td></tr></table></figure>
<p>输入我们的脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取当前日期和时间</span></span><br><span class="line">date=$(date +%Y-%m-%d-%H-%M)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取脚本第一个参数，即目标目录</span></span><br><span class="line">target_dir=$1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 遍历目标目录中的所有文件</span></span><br><span class="line">for file in &quot;$target_dir&quot;/*</span><br><span class="line">do</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 如果文件是一个普通文件而不是目录</span></span><br><span class="line">  if [ -f &quot;$file&quot; ]; then</span><br><span class="line">    # 获取文件名和扩展名</span><br><span class="line">    filename=$(basename -- &quot;$file&quot;)</span><br><span class="line">    extension=&quot;$&#123;filename##*.&#125;&quot;</span><br><span class="line">    filename=&quot;$&#123;filename%.*&#125;&quot;</span><br><span class="line">    </span><br><span class="line">    # 如果文件名中已经有日期和时间后缀，则不再添加</span><br><span class="line">    if [[ $filename == *-$date ]]; then</span><br><span class="line">      continue</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    # 为文件名添加日期和时间后缀</span><br><span class="line">    new_filename=&quot;$filename-$date.$extension&quot;</span><br><span class="line">    </span><br><span class="line">    # 重命名文件</span><br><span class="line">    mv &quot;$file&quot; &quot;$target_dir/$new_filename&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>用<code>:wq!</code>保存退出，再新建测试文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir test</span><br><span class="line">cd test</span><br><span class="line">touch test1.txt test2.txt</span><br><span class="line">mkdir sub_test</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>
<p>添加管理员权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod -R 777 ./</span><br></pre></td></tr></table></figure>
<p>运行脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./task4.sh ./test</span><br></pre></td></tr></table></figure>
<p>可以看到脚本成功运行</p>
<figure>
<img src="/report/os-report/image-20230712115418817.png" alt="image-20230712115418817">
<figcaption aria-hidden="true">image-20230712115418817</figcaption>
</figure>
<h2 id="四实验结果">四、实验结果</h2>
<h3 id="用nasm编写mbr引导程序-1">4.1 用NASM编写MBR引导程序</h3>
<p>结果如图所示，屏幕上出现了Hello, OS world！因为boot.asm原理是先用b
0x7c00设断点，然后c指令让代码执行到断点，再一直<code>n</code>单步运行即可，会出现"Hello,
OS world!"。</p>
<figure>
<img src="/report/os-report/image-20230712115425104.png" alt="image-20230712115425104">
<figcaption aria-hidden="true">image-20230712115425104</figcaption>
</figure>
<figure>
<img src="/report/os-report/image-20230712115431025.png" alt="image-20230712115431025">
<figcaption aria-hidden="true">image-20230712115431025</figcaption>
</figure>
<h3 id="裁剪并编译linux内核-1">4.2 裁剪并编译linux内核</h3>
<p>编译完成后会提示<code>kernel is ready</code></p>
<figure>
<img src="/report/os-report/image-20230712115438488.png" alt="image-20230712115438488">
<figcaption aria-hidden="true">image-20230712115438488</figcaption>
</figure>
<p>原linux内核版本信息如下：</p>
<figure>
<img src="/report/os-report/image-20230712115444603.png" alt="image-20230712115444603">
<figcaption aria-hidden="true">image-20230712115444603</figcaption>
</figure>
<p>在ubuntu高级选项中选择编译成功的内核，加载之，使用相同的命令可以看到如下信息。证明内核编译成功：</p>
<figure>
<img src="/report/os-report/image-20230712115450901.png" alt="image-20230712115450901">
<figcaption aria-hidden="true">image-20230712115450901</figcaption>
</figure>
<h3 id="为linux内核增添系统调用-1">4.3 为linux内核增添系统调用</h3>
<p>使用gcc编译我们的<code>test.c</code>文件，随后运行我们的<code>run.exe</code></p>
<figure>
<img src="/report/os-report/image-20230712115456676.png" alt="image-20230712115456676">
<figcaption aria-hidden="true">image-20230712115456676</figcaption>
</figure>
<h3 id="在linux下编写shell文件-1">4.4 在linux下编写shell文件</h3>
<p>这里使用了<code>touch</code>命令创建了测试文件，用<code>mkdir</code>命令创建了测试子文件夹，然后使用<code>./task5.sh ./</code>命令运行自己编写的脚本，用ls命令查看脚本的运行结果。</p>
<figure>
<img src="/report/os-report/image-20230712115502842.png" alt="image-20230712115502842">
<figcaption aria-hidden="true">image-20230712115502842</figcaption>
</figure>
<h2 id="五实验错误排查和解决方法">五、实验错误排查和解决方法</h2>
<h3 id="用nasm编写mbr引导程序-2">5.1 用NASM编写MBR引导程序</h3>
<h4 id="错误1用bochs--f-bochsrc启动bochs时报错reading-from-bochsrc-failed">错误1：用bochs
-f bochsrc启动bochs时报错reading from bochsrc failed</h4>
<p>这个错误通常意味着Bochs无法读取其配置文件（bochsrc），可能是因为文件不存在或者无法访问。经过查阅相关资料，得到了了如下的解决方案：</p>
<ol type="1">
<li><p>确保 bochsrc 文件存在于当前目录或指定的目录中。你可以使用
<code>ls</code> 命令查看当前目录的文件列表，或者使用 <code>cd</code>
命令切换到正确的目录。</p></li>
<li><p>确保你有读取 bochsrc 文件的权限。你可以使用 <code>ls -l</code>
命令查看文件权限。</p></li>
<li><p>如果你指定了一个非当前目录中的 bochsrc
文件，请确保路径是正确的。</p></li>
<li><p>如果你使用了 Windows 系统，请确保 bochsrc
文件名正确，并且大小写匹配。Windows 是大小写不敏感的，但是 Bochs
是大小写敏感的。</p></li>
<li><p>如果以上方法都无法解决问题，可以尝试重新安装 Bochs 或者查看 Bochs
的日志文件（通常位于 /var/log/bochs 或者
/var/log/messages）来查找更多信息。</p></li>
</ol>
<p>基于上述描述，我对bochs文件进行了如下的改写：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">megs:<span class="number">32</span></span><br><span class="line">romimage: <span class="keyword">file</span>=<span class="regexp">/usr/</span>share<span class="regexp">/bochs/</span>BIOS-bochs-latest</span><br><span class="line">vgaromimage: <span class="keyword">file</span>=<span class="regexp">/usr/</span>share<span class="regexp">/bochs/</span>VGABIOS-lgpl-latest</span><br><span class="line"></span><br><span class="line">floppya : <span class="number">1</span>_44=a.img, status=inserted</span><br><span class="line">boot : floppy</span><br><span class="line">log : bochsout.txt</span><br><span class="line">mouse : enabled=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>改写完成后，没有出现报错。</p>
<h4 id="错误2no-bootable-device">错误2：No bootable device</h4>
<p>"No bootable device" 是 Bochs 模拟器的错误提示，通常意味着 Bochs
无法找到可引导设备或者无法正确读取 MBR
引导扇区。经过查阅我发现了如下的提示：</p>
<ol type="1">
<li>确保你的 MBR
引导程序编写正确，并且已经被正确地写入到可引导设备（通常是硬盘的第一个扇区）上。你可以使用
<code>dd</code> 命令将编写好的 MBR 引导程序写入到硬盘的第一个扇区。</li>
<li>确保你的 Bochs 配置文件（bochsrc）正确地指定了可引导设备。你可以使用
<code>ata0-master</code> 或 <code>ata0-slave</code>
指定硬盘设备。例如，如果你的硬盘映像文件为
disk.img，则可以添加以下行到你的 bochsrc 文件中：</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ata0-master: <span class="attribute">type</span>=disk, <span class="attribute">path</span>=<span class="string">&quot;disk.img&quot;</span>, <span class="attribute">mode</span>=flat, <span class="attribute">cylinders</span>=XXX, <span class="attribute">heads</span>=XXX, <span class="attribute">spt</span>=XXX</span><br></pre></td></tr></table></figure>
<p>​ 其中的 <code>XXX</code> 应该替换为你硬盘的实际参数。</p>
<ol start="3" type="1">
<li>确保 Bochs 正确读取了你的 bochsrc 文件。你可以在命令行中使用
<code>-f</code> 选项指定 bochsrc 文件路径：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bochs -f /path/to/bochsrc</span><br></pre></td></tr></table></figure>
<ol start="4" type="1">
<li><p>确保你的 MBR
引导程序没有错误或死循环。你可以在编写代码时使用调试器或者添加输出语句来定位问题。</p></li>
<li><p>如果以上方法都无法解决问题，可以尝试重新安装 Bochs 或者查看 Bochs
的日志文件（通常位于 /var/log/bochs 或者
/var/log/messages）来查找更多信息。</p></li>
</ol>
<p>经过对照，我将编译得到的<code>boot.bins a.img</code>文件同<code>bochsrc</code>放在一个目录下，之后再运行bochs虚拟机，没有报错。</p>
<h3 id="裁剪并编译linux内核-2">5.2 裁剪并编译linux内核</h3>
<h4 id="问题1缺少编译所需的软件包或库">问题1：缺少编译所需的软件包或库</h4>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;make: *** No rule to make target &#x27;menuconfig&#x27;. Stop.&quot;</span></span><br></pre></td></tr></table></figure>
<p>当运行 <code>make menuconfig</code> 命令时，出现 "make: *** No rule
to make target 'menuconfig'. Stop." 错误。</p>
<p>这个错误通常意味着缺少 ncurses 库。 Ubuntu
系统中，可以使用以下命令安装：</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libncurses5-<span class="built_in">dev</span> libncursesw5-<span class="built_in">dev</span></span><br></pre></td></tr></table></figure>
<h4 id="问题2内核配置错误">问题2：内核配置错误</h4>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">error: </span>Your kernel configuration is invalid.</span><br></pre></td></tr></table></figure>
<p>解决方案：运行 <code>make menuconfig</code>
命令重新配置内核选项，确保所有选项都正确设置。</p>
<h4 id="问题3内存不足">问题3：内存不足</h4>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtual <span class="keyword">memory</span> exhausted: Cannot allocate <span class="keyword">memory</span></span><br></pre></td></tr></table></figure>
<p>解决方案：增加系统的虚拟内存或者物理内存。可以使用 <code>dd</code>
命令创建一个 swap 文件并将其挂载到系统上。</p>
<h4 id="问题4构建内核时缺少必需的文件或目录">问题4：构建内核时缺少必需的文件或目录：</h4>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">error: </span>file &#x27;arch/x86/entry/syscalls/syscall_64.tbl&#x27; not found</span><br></pre></td></tr></table></figure>
<p>解决方案：运行 <code>make ARCH=x86_64 headers_install</code>
命令安装必要的文件和目录。</p>
<h4 id="问题5缺少内核模块">问题5：缺少内核模块</h4>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">error: </span>module &#x27;xxx&#x27; not found</span><br></pre></td></tr></table></figure>
<p>解决方案：运行 <code>make modules_install</code>
命令安装内核模块。</p>
<h4 id="问题6没有规则可制作目标">问题6：没有规则可制作目标</h4>
<p>在编译时出现下列报错：</p>
<p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make[<span class="number">1</span>]: *** 没有规则可制作目标“debian/canonical-revoked-certs.pem”，由“certs/x509_revocation_list” 需求。 停止。</span><br><span class="line">make[<span class="number">1</span>]: *** 正在等待未完成的任务....</span><br><span class="line"><span class="symbol">CC</span> certs/blacklist.o</span><br><span class="line"><span class="symbol">CC</span> kernel/watchdog_hld.o</span><br><span class="line">make: *** [<span class="symbol">Makefile</span>:<span class="number">1868</span>：certs] 错误 <span class="number">2</span></span><br><span class="line">make: *** 正在等待未完成的任务....</span><br></pre></td></tr></table></figure></p>
<p>解决方法：</p>
<p>只要你在编译内核的时候，报错类似如上的错误，都可以用此方法去解决。具体如下：</p>
<p>1、编辑 .config 配置文件。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-VirtualBox:<span class="regexp">/usr/</span>src/linux<span class="comment"># vim .config</span></span><br></pre></td></tr></table></figure>
<p>2、再将</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_SYSTEM_TRUSTED_KEYS</span>=<span class="string">&quot;debian/canonical-certs.pem&quot;</span></span><br><span class="line"><span class="attr">CONFIG_SYSTEM_REVOCATION_KEYS</span>=<span class="string">&quot;debian/canonical-revoked-certs.pem&quot;</span></span><br></pre></td></tr></table></figure>
<p>修改为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_SYSTEM_TRUSTED_KEYS</span>=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">CONFIG_SYSTEM_REVOCATION_KEYS</span>=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<figure>
<img src="/report/os-report/image-20230712115513764.png" alt="image-20230712115513764">
<figcaption aria-hidden="true">image-20230712115513764</figcaption>
</figure>
<p>3、保存后，再次重新执行“编译内核”命令即可！</p>
<h3 id="为linux内核增添系统调用-2">5.3 为linux内核增添系统调用</h3>
<h4 id="错误1编译时出现undefined__x64_sys_add">错误1：编译时出现<code>undefined:__x64_sys_add</code></h4>
<p>在编译内核直到最后一步生成vmlinux虚拟机的时候才会出现上述报错，排查起来非常耗时耗力。经过与同学们讨论，发现在编写<code>syscall_64.tbl</code>时不能使用<code>__x64_sys_add</code>,只能使用<code>sys_add</code>。其次，在编写函数时，不能使用int类型作为返回值，必须使用long作为返回值。全部修改后，正常编译。</p>
<h4 id="错误2模块加载错误">错误2：模块加载错误</h4>
<p>使用下列命令进行检查</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod <span class="string">| grep [module_name]</span></span><br></pre></td></tr></table></figure>
<p>如果没有输出或出现错误消息，则表示模块没有正确加载，可以尝试重新编译和加载模块。</p>
<h4 id="错误3修改编译后仍然是修改前的结果">错误3：修改编译后仍然是修改前的结果</h4>
<p>因为make程序有缓存，编译前应该执行<code>make mrproper &amp;&amp; make clean</code>清除之前编译生成的目标文件。</p>
<h3 id="在linux下编写shell文件-2">5.4 在linux下编写shell文件</h3>
<h4 id="错误1解释器错误">错误1：解释器错误</h4>
<p>错误信息：/bin/bash: bad interpreter: No such file or directory</p>
<p>这个错误通常是因为脚本的第一行指定的解释器不正确或解释器路径错误。</p>
<p>解决方法：检查脚本的第一行，确保解释器路径正确。</p>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br></pre></td></tr></table></figure>
<h4 id="错误2权限问题">错误2：权限问题</h4>
<p>错误信息：Permission denied</p>
<p>这个错误通常是因为脚本没有执行权限。</p>
<p>解决方法：使用 chmod 命令赋予脚本执行权限。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> chmod -R <span class="number">777</span> ./</span><br></pre></td></tr></table></figure>
<h4 id="错误3语法错误">错误3：语法错误</h4>
<p>错误信息：syntax error near unexpected token</p>
<p>这个错误通常是因为脚本中存在语法错误。</p>
<p>解决方法：检查脚本的语法，确保语法正确。</p>
<h4 id="错误4变量未定义">错误4：变量未定义</h4>
<p>错误信息：uninitialized variable</p>
<p>这个错误通常是因为脚本中使用了未定义的变量。</p>
<p>解决方法：确保变量已经定义并且有值。</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bashCopy code#!<span class="regexp">/bin/</span>bash</span><br><span class="line">echo <span class="symbol">$u</span>ndefined_variable</span><br></pre></td></tr></table></figure>
<h2 id="六实验参考资料和网址">六、实验参考资料和网址</h2>
<ul>
<li><p>教学课件</p></li>
<li><p>解决Linux"没有规则可制作目标“debian/canonical-revoked-certs.pem”，由“certs/x509_revocation_list”
需求。https://www.xgboke.com/16586.html</p></li>
<li><p>NASM官方网站：https://www.nasm.us/</p></li>
<li><p>NASM教程：https://cs.lmu.edu/~ray/notes/nasmtutorial/</p></li>
<li><p>《PC Assembly
Language》：https://pacman128.github.io/pcasm/</p></li>
<li><p>Ubuntu官方网站：https://ubuntu.com/</p></li>
<li><p>Linux内核官方网站：https://www.kernel.org/</p></li>
<li><p>《深入理解Linux内核》第五版第三章</p></li>
<li><p>《深入理解Linux内核》第五版第十二章</p></li>
<li><p>Linux Shell教程：https://www.learnshell.org/</p></li>
<li><p>Windows批处理教程：https://www.tutorialspoint.com/batch_script/</p></li>
</ul>
<h1 align="center">
《操作系统原理》实验报告(二)
</h1>
<table style="width:100%;">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 18%">
<col style="width: 7%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">姓名</th>
<th style="text-align: center;">dekrt</th>
<th style="text-align: center;">学号</th>
<th style="text-align: center;">U2021172??</th>
<th style="text-align: center;">专业班级</th>
<th style="text-align: center;">软件2102班</th>
<th style="text-align: center;">时间</th>
<th style="text-align: center;">2023.04.10</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<h2 id="一实验目的-1">一、实验目的</h2>
<p>1）理解进程/线程的概念和应用编程过程；</p>
<p>2）理解进程/线程的同步机制和应用编程；</p>
<p>3）掌握和推广国产操作系统（推荐银河麒麟或优麒麟，建议）</p>
<h2 id="二实验内容-1">二、实验内容</h2>
<p>1）在Linux/Windows下创建2个线程A和B，循环输出数据或字符串。</p>
<p>2）在Linux下创建（fork）一个子进程，实验wait/exit函数。</p>
<p>3）在Windows/Linux下，利用线程实现并发画圆画方。</p>
<p>4）在Windows或Linux下利用线程实现“生产者-消费者”同步控制。</p>
<p>5）在Linux下利用信号机制(signal)实现进程通信。</p>
<p>6）在Windows或Linux下模拟哲学家就餐，提供死锁和非死锁解法。</p>
<p>7）研读Linux内核并用printk调试进程创建和调度策略的相关信息。</p>
<h2 id="三实验环境和核心代码-1">三、实验环境和核心代码</h2>
<h3 id="运用线程分别输出数据">3.1 运用线程分别输出数据</h3>
<blockquote>
<p>开发环境：windows 11，编辑工具：vscode , 编译工具: gcc</p>
</blockquote>
<p>核心代码，输出见注释：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> re register</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_1</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">usleep</span>(<span class="number">10000</span>); <span class="comment">// 避免输出异常</span></span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;B: %04d\n&quot;</span>, i);</span><br><span class="line">        <span class="comment">// 使用usleep函数将程序挂起2e5微秒，即0.2秒</span></span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">200000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_2</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">1000</span>; i &gt;= <span class="number">1</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;A: %04d\n&quot;</span>, i);</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">200000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> pid1, pid2;</span><br><span class="line">	<span class="built_in">pthread_create</span>(&amp;pid1, <span class="literal">NULL</span>, thread_1, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">pthread_create</span>(&amp;pid2, <span class="literal">NULL</span>, thread_2, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">pthread_join</span>(pid1, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">pthread_join</span>(pid2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="linux下实验waitexit函数">3.2 Linux下实验wait/exit函数</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.67，编辑工具：vim &amp;
gedit， 编译工具: gcc</p>
</blockquote>
<h4 id="效果一">3.2.1 效果一</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fork failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 子进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I am child process, my pid is %d, my parent pid is %d\n&quot;</span>, <span class="built_in">getpid</span>(), <span class="built_in">getppid</span>());</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 子进程进入死循环</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 父进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I am parent process, my pid is %d, my child pid is %d\n&quot;</span>, <span class="built_in">getpid</span>(), pid);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Parent process is exiting now...\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="效果二">3.2.2 效果二</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;fork failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 子进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I am child process, my pid is %d, my parent pid is %d\n&quot;</span>, <span class="built_in">getpid</span>(), <span class="built_in">getppid</span>());</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Child process is exiting now with return value 42\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">114514</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 父进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I am parent process, my pid is %d, my child pid is %d\n&quot;</span>, <span class="built_in">getpid</span>(), pid);</span><br><span class="line">        <span class="built_in">wait</span>(&amp;status);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Child process returned with exit status %d\n&quot;</span>, <span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="生产者-消费者同步控制">3.3 “生产者-消费者”同步控制</h3>
<blockquote>
<p>开发环境：windows 11，编辑工具：vscode , 编译工具: gcc</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_SIZE 10</span></span><br><span class="line"></span><br><span class="line">CRITICAL_SECTION g_csBuffer;</span><br><span class="line"><span class="keyword">int</span> g_Buffer[BUFFER_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> g_nCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">HANDLE g_hSemProd1;</span><br><span class="line">HANDLE g_hSemProd2;</span><br><span class="line">HANDLE g_hSemCons;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintBuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Buffer Status: &quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; BUFFER_SIZE; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (g_Buffer[i] == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;[    ]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; g_Buffer[i] &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	std::cout &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ProducerThread</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> nProducerID = *(<span class="keyword">int</span> *)lpParam;</span><br><span class="line">	<span class="keyword">int</span> nStartNum = nProducerID * <span class="number">1000</span>;</span><br><span class="line">	<span class="built_in">srand</span>(<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> nData = nStartNum + <span class="built_in">rand</span>() % <span class="number">1000</span>;</span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="built_in">rand</span>() % <span class="number">901</span> + <span class="number">100</span>); <span class="comment">// 等待100ms-1s</span></span><br><span class="line">		<span class="built_in">EnterCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">		<span class="keyword">if</span> (g_nCount == BUFFER_SIZE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">LeaveCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">			<span class="keyword">if</span> (nProducerID == <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">WaitForSingleObject</span>(g_hSemProd1, INFINITE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">WaitForSingleObject</span>(g_hSemProd2, INFINITE);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			g_Buffer[g_nCount] = nData;</span><br><span class="line">			g_nCount++;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Producer &quot;</span> &lt;&lt; nProducerID &lt;&lt; <span class="string">&quot; produced data: &quot;</span> &lt;&lt; nData &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">PrintBuffer</span>();</span><br><span class="line">			<span class="built_in">LeaveCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">			<span class="built_in">ReleaseSemaphore</span>(g_hSemCons, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ConsumerThread</span><span class="params">(LPVOID lpParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> nConsumerID = *(<span class="keyword">int</span> *)lpParam;</span><br><span class="line">	<span class="built_in">srand</span>(<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="built_in">rand</span>() % <span class="number">901</span> + <span class="number">100</span>); <span class="comment">// 等待100ms-1s</span></span><br><span class="line">		<span class="built_in">EnterCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">		<span class="keyword">if</span> (g_nCount == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">LeaveCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">			<span class="built_in">WaitForSingleObject</span>(g_hSemCons, INFINITE);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> nData = g_Buffer[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; g_nCount - <span class="number">1</span>; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				g_Buffer[i] = g_Buffer[i + <span class="number">1</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			g_Buffer[g_nCount - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			g_nCount--;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;Consumer &quot;</span> &lt;&lt; nConsumerID &lt;&lt; <span class="string">&quot; consumed data: &quot;</span> &lt;&lt; nData &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">PrintBuffer</span>();</span><br><span class="line">			<span class="built_in">LeaveCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">			<span class="keyword">if</span> (nData &gt;= <span class="number">1000</span> &amp;&amp; nData &lt;= <span class="number">1999</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ReleaseSemaphore</span>(g_hSemProd1, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ReleaseSemaphore</span>(g_hSemProd2, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">InitializeCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line">	g_hSemProd1 = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, BUFFER_SIZE, BUFFER_SIZE, <span class="literal">NULL</span>);</span><br><span class="line">	g_hSemProd2 = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, BUFFER_SIZE, BUFFER_SIZE, <span class="literal">NULL</span>);</span><br><span class="line">	g_hSemCons = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, <span class="number">0</span>, BUFFER_SIZE, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">int</span> nProd1ID = <span class="number">1</span>, nProd2ID = <span class="number">2</span>, nCons1ID = <span class="number">1</span>, nCons2ID = <span class="number">2</span>, nCons3ID = <span class="number">3</span>;</span><br><span class="line">	HANDLE hProd1 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ProducerThread, &amp;nProd1ID, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	HANDLE hProd2 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ProducerThread, &amp;nProd2ID, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	HANDLE hCons1 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ConsumerThread, &amp;nCons1ID, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	HANDLE hCons2 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ConsumerThread, &amp;nCons2ID, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	HANDLE hCons3 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ConsumerThread, &amp;nCons3ID, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hProd1, INFINITE);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hProd2, INFINITE);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hCons1, INFINITE);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hCons2, INFINITE);</span><br><span class="line">	<span class="built_in">WaitForSingleObject</span>(hCons3, INFINITE);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CloseHandle</span>(hProd1);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hProd2);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hCons1);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hCons2);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hCons3);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(g_hSemProd1);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(g_hSemProd2);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(g_hSemCons);</span><br><span class="line">	<span class="built_in">DeleteCriticalSection</span>(&amp;g_csBuffer);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="模拟哲学家就餐">3.4 模拟哲学家就餐</h3>
<blockquote>
<p>开发环境：windows 11，编辑工具：vscode , 编译工具: gcc</p>
</blockquote>
<h4 id="可能产生死锁">3.4.1 可能产生死锁</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">std::string name[<span class="number">5</span>] = &#123; <span class="string">&quot;0&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>,<span class="string">&quot;4&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> a[<span class="number">5</span>] = &#123; <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">random</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">srand</span>(a);</span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">rand</span>() % <span class="number">400</span> + <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//子线程函数  </span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">philosopher</span><span class="params">(LPVOID lpParam)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> id = i++;</span><br><span class="line">	<span class="keyword">int</span> time;</span><br><span class="line">	HANDLE right, left;</span><br><span class="line">	left = <span class="built_in">OpenSemaphore</span>(SEMAPHORE_ALL_ACCESS, FALSE, name[id].<span class="built_in">c_str</span>());<span class="comment">//通过信号量名，获得信号量对象句柄</span></span><br><span class="line">	right = <span class="built_in">OpenSemaphore</span>(SEMAPHORE_ALL_ACCESS, FALSE, name[(id + <span class="number">4</span>) % <span class="number">5</span>].<span class="built_in">c_str</span>());</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		time = <span class="built_in">random</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d开始思考，将思考%dms\n&quot;</span>, id, time);</span><br><span class="line">		<span class="built_in">Sleep</span>(time);</span><br><span class="line">		time = <span class="built_in">random</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d开始休息，将休息%dms\n&quot;</span>, id, time);</span><br><span class="line">		<span class="built_in">Sleep</span>(time);</span><br><span class="line">		<span class="comment">//p(left)</span></span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(left, INFINITE);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d取了左手边的筷子\t%d\n&quot;</span>, id, id);</span><br><span class="line">		<span class="comment">//p(right)</span></span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(right, INFINITE);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d取了右手边的筷子\t%d\n&quot;</span>, id, (id + <span class="number">4</span>) % <span class="number">5</span>);</span><br><span class="line">		<span class="comment">//吃饭</span></span><br><span class="line">		time = <span class="built_in">random</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d开始吃饭，将吃饭%dms\n&quot;</span>, id, time);</span><br><span class="line">		<span class="built_in">Sleep</span>(time);</span><br><span class="line">		<span class="comment">//v</span></span><br><span class="line">		<span class="built_in">ReleaseSemaphore</span>(left, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d放下左手边的筷子\t%d\n&quot;</span>, id, id);</span><br><span class="line">		<span class="built_in">ReleaseSemaphore</span>(right, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d放下右手边的筷子\t%d\n&quot;</span>, id, (id + <span class="number">4</span>) % <span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	HANDLE S[<span class="number">5</span>]; <span class="comment">//五个信号量</span></span><br><span class="line">	HANDLE hThread[<span class="number">5</span>]; <span class="comment">//五个线程</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		S[i] = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">1</span>, name[i].<span class="built_in">c_str</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		hThread[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, philosopher, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">WaitForMultipleObjects</span>(<span class="number">5</span>, hThread, TRUE, INFINITE); 	<span class="comment">//等待子线程运行 </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(S[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="不会产生死锁">3.4.2 不会产生死锁</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">std::string name[<span class="number">5</span>] = &#123; <span class="string">&quot;0&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>,<span class="string">&quot;4&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">int</span> a[<span class="number">5</span>] = &#123; <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">random</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">srand</span>(a);</span><br><span class="line">	<span class="keyword">return</span> (<span class="built_in">rand</span>() % <span class="number">400</span> + <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//子线程函数  </span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">philosopher</span><span class="params">(LPVOID lpParam)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">srand</span>((<span class="keyword">unsigned</span>)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">	<span class="keyword">int</span> id = i++;</span><br><span class="line">	<span class="keyword">int</span> time;</span><br><span class="line">	HANDLE chops[<span class="number">2</span>];</span><br><span class="line">	chops[<span class="number">0</span>] = <span class="built_in">OpenSemaphore</span>(SEMAPHORE_ALL_ACCESS, FALSE, name[id].<span class="built_in">c_str</span>());</span><br><span class="line">	chops[<span class="number">1</span>] = <span class="built_in">OpenSemaphore</span>(SEMAPHORE_ALL_ACCESS, FALSE, name[(id + <span class="number">4</span>) % <span class="number">5</span>].<span class="built_in">c_str</span>());</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		time = <span class="built_in">random</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d开始思考，将思考%dms\n&quot;</span>, id, time);</span><br><span class="line">		<span class="built_in">Sleep</span>(time);</span><br><span class="line">		time = <span class="built_in">random</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d开始休息，将休息%dms\n&quot;</span>, id, time);</span><br><span class="line">		<span class="built_in">Sleep</span>(time);</span><br><span class="line">	</span><br><span class="line">		<span class="comment">//p</span></span><br><span class="line">		<span class="built_in">WaitForMultipleObjects</span>(<span class="number">2</span>, chops, <span class="literal">true</span>, INFINITE);<span class="comment">//true表面只有等待所有信号量有效时，再往下执行。（FALSE 当有其中一个信号量有效时就向下执行）</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d同时取了两边的筷子\t%d，%d\n&quot;</span>, id, id, (id + <span class="number">4</span>) % <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//吃饭</span></span><br><span class="line">		time = <span class="built_in">random</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d开始吃饭，将吃饭%dms\n&quot;</span>, id, time);</span><br><span class="line">		<span class="built_in">Sleep</span>(time);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//v</span></span><br><span class="line">		<span class="built_in">ReleaseSemaphore</span>(chops[<span class="number">0</span>], <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d放下左手边的筷子\t%d\n&quot;</span>, id, id);</span><br><span class="line">		<span class="built_in">ReleaseSemaphore</span>(chops[<span class="number">1</span>], <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;哲学家%d放下右手边的筷子\t%d\n&quot;</span>, id, (id + <span class="number">4</span>) % <span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	HANDLE S[<span class="number">5</span>]; <span class="comment">//五个信号量</span></span><br><span class="line">	HANDLE hThread[<span class="number">5</span>]; <span class="comment">//五个线程</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		S[i] = <span class="built_in">CreateSemaphore</span>(<span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">1</span>, name[i].<span class="built_in">c_str</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		hThread[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, philosopher, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">WaitForMultipleObjects</span>(<span class="number">5</span>, hThread, TRUE, INFINITE); 	<span class="comment">//等待子线程运行 </span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(S[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="linux下调用printk查看进程信息">3.5
Linux下调用printk查看进程信息</h3>
<ol type="1">
<li>编写应用程序Hello.c，代码如下：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the parent process, PID = %d.\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This is the child process, PID = %d, PPID = %d.\n&quot;</span>, getpid(), getppid());</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This is the parent process, PID = %d, child PID = %d.\n&quot;</span>, getpid(), pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该程序先输出父进程的PID，然后调用fork创建子进程，分别输出父进程、子进程的PID以及父进程对应的子进程PID。</p>
<ol start="2" type="1">
<li>在Linux内核中找到do_fork函数，该函数定义在kernel/fork.c文件中。在该函数内，根据提示2，我们可以添加代码以输出调试信息。为了避免频繁输出调试信息，可以使用全局变量和系统调用来控制输出。</li>
</ol>
<p>首先，在<code>include/linux/init.h</code>文件中定义全局变量和系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">bool</span> my_debug_flag;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">set_my_debug</span><span class="params">(<span class="keyword">bool</span> value)</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中<code>my_debug_flag</code>表示是否输出调试信息的标志，<code>set_my_debug</code>函数用于修改标志的值。</p>
<p>然后，在<code>kernel/fork.c</code>文件中定义全局变量和系统调用的具体实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> my_debug_flag = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_my_debug</span><span class="params">(<span class="keyword">bool</span> value)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_debug_flag = value;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(set_my_debug);</span><br></pre></td></tr></table></figure>
<p>其中，<code>EXPORT_SYMBOL</code>用于将<code>set_my_debug</code>函数导出，使得应用程序可以调用该函数。</p>
<p>接下来，在<code>copy_process</code>函数中添加代码以输出调试信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (my_debug_flag) </span><br><span class="line">&#123;</span><br><span class="line">	printk(KERN_INFO <span class="string">&quot;Creating Process: cmd=%s, pid=%d, ppid=%d\n&quot;</span>, current-&gt;comm, current-&gt;pid, current-&gt;parent-&gt;pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该代码会在创建进程时输出调试信息，其中current-&gt;comm表示当前进程的命令名，current-&gt;pid表示新创建进程的PID，current-&gt;parent-&gt;pid表示当前进程的父进程的PID。</p>
<p>最后，在Hello.c中添加代码以控制是否输出调试信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET_DEBUG_FLAG 550</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is the parent process, PID = %d.\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    syscall(SET_DEBUG_FLAG, <span class="number">1</span>);  <span class="comment">// 开启调试信息输出</span></span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    syscall(SET_DEBUG_FLAG, <span class="number">0</span>);  <span class="comment">// 关闭调试信息输出</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This is the child process, PID = %d, PPID = %d.\n&quot;</span>, getpid(), getppid());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;This is the parent process, PID = %d, child PID = %d.\n&quot;</span>, getpid(), pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>syscall</code>用于调用系统调用，<code>SET_DEBUG_FLAG</code>是自定义的系统调用号，1表示开启调试信息输出，0表示关闭调试信息输出。</p>
<h2 id="四实验结果-1">四、实验结果</h2>
<h3 id="运用线程分别输出数据-1">4.1 运用线程分别输出数据</h3>
<figure>
<img src="/report/os-report/image-20230410185350620.png" alt="image-20230410185350620">
<figcaption aria-hidden="true">image-20230410185350620</figcaption>
</figure>
<h3 id="linux下实验waitexit函数-1">4.2 Linux下实验wait/exit函数</h3>
<h4 id="效果一-1">4.2.1 效果一</h4>
<figure>
<img src="/report/os-report/image-20230719212749631.png" alt="image-20230719212749631">
<figcaption aria-hidden="true">image-20230719212749631</figcaption>
</figure>
<h4 id="效果二-1">4.2.2 效果二</h4>
<figure>
<img src="/report/os-report/image-20230719212759924.png" alt="image-20230719212759924">
<figcaption aria-hidden="true">image-20230719212759924</figcaption>
</figure>
<h3 id="生产者-消费者同步控制-1">4.3 “生产者-消费者”同步控制</h3>
<figure>
<img src="/report/os-report/image-20230719212807507.png" alt="image-20230719212807507">
<figcaption aria-hidden="true">image-20230719212807507</figcaption>
</figure>
<h3 id="在linux下编写shell文件-3">4.4 在linux下编写shell文件</h3>
<h4 id="死锁解法">4.4.1 死锁解法</h4>
<figure>
<img src="/report/os-report/image-20230719212816563.png" alt="image-20230719212816563">
<figcaption aria-hidden="true">image-20230719212816563</figcaption>
</figure>
<h4 id="非死锁解法">4.4.2 非死锁解法</h4>
<figure>
<img src="/report/os-report/image-20230719212826164.png" alt="image-20230719212826164">
<figcaption aria-hidden="true">image-20230719212826164</figcaption>
</figure>
<h3 id="linux下调用printk查看进程信息-1">4.5
Linux下调用printk查看进程信息</h3>
<figure>
<img src="/report/os-report/image-20230719212833145.png" alt="image-20230719212833145">
<figcaption aria-hidden="true">image-20230719212833145</figcaption>
</figure>
<p>Creating Process的输出出现在最后一行。</p>
<figure>
<img src="/report/os-report/image-20230719212841111.png" alt="image-20230719212841111">
<figcaption aria-hidden="true">image-20230719212841111</figcaption>
</figure>
<h2 id="五实验错误排查和解决方法-1">五、实验错误排查和解决方法</h2>
<h3 id="error-cast-from-lpvoid-aka-void-to-int-loses-precision--fpermissive">5.1
[Error] cast from 'LPVOID {aka void*}' to 'int' loses precision
[-fpermissive]</h3>
<p>在类型转换时，有如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">philosopher</span><span class="params">(LPVOID param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> id = (<span class="keyword">int</span>)param;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在强制类型转换时会报错，应做如下修改：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">philosopher</span><span class="params">(LPVOID param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> id = *(<span class="keyword">int</span>*)param;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="linux下用printk输出信息">5.2 Linux下用printk输出信息</h3>
<ul>
<li>添加printk代码时，要注意添加到copy_process函数中，因为较高版本的linux内核中fork.c文件不存在do_fork()函数。</li>
<li>添加printk代码时，要在字符串前添加<code>KERN_INFO</code>的宏定义，防止调试信息在dmesg中被过滤。</li>
<li>编译内核时属于增量编译，速度较快，但是编译完成后要使用<code>make modules_install</code>
和 <code>make install</code>命令进行安装，否则会出错。</li>
<li>添加全局变量时，要注意<code>EXPORT_SYMBOL(set_my_debug);</code></li>
</ul>
<h2 id="六实验参考资料和网址-1">六、实验参考资料和网址</h2>
<ul>
<li>教学课件</li>
</ul>
<ol type="1">
<li>Linux下创建2个线程A和B，循环输出数据或字符串</li>
</ol>
<ul>
<li>参考资料：
https://www.geeksforgeeks.org/creating-threads-in-linux-using-pthread/</li>
<li>网址： https://github.com/Abdurraheem/Two-Threads-Output</li>
</ul>
<ol start="2" type="1">
<li>在Linux下创建（fork）一个子进程，实验wait/exit函数</li>
</ol>
<ul>
<li>参考资料： https://www.geeksforgeeks.org/wait-system-call-c/</li>
<li>网址： https://github.com/Abdurraheem/Linux-Child-Process</li>
</ul>
<ol start="3" type="1">
<li>在Windows或Linux下利用线程实现“生产者-消费者”同步控制</li>
</ol>
<ul>
<li>参考资料：
https://www.geeksforgeeks.org/producer-consumer-solution-using-threads-in-java/</li>
<li>网址： https://github.com/Abdurraheem/Producer-Consumer-Problem</li>
</ul>
<ol start="4" type="1">
<li>在Windows或Linux下模拟哲学家就餐，提供死锁和非死锁解法</li>
</ol>
<ul>
<li>参考资料：
https://www.geeksforgeeks.org/dining-philosophers-problem-using-semaphores/</li>
<li>网址：
https://github.com/Abdurraheem/Dining-Philosophers-Problem</li>
</ul>
<ol start="5" type="1">
<li>研读Linux内核并用printk调试进程创建和调度策略的相关信息</li>
</ol>
<ul>
<li>参考资料： https://www.kernel.org/doc/html/latest/</li>
<li>网址： https://github.com/torvalds/linux</li>
</ul>
<h1 align="center">
《操作系统原理》实验报告(三)
</h1>
<table style="width:100%;">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 18%">
<col style="width: 7%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">姓名</th>
<th style="text-align: center;">dekrt</th>
<th style="text-align: center;">学号</th>
<th style="text-align: center;">U2021172??</th>
<th>专业班级</th>
<th style="text-align: center;">软件2102班</th>
<th style="text-align: center;">时间</th>
<th style="text-align: center;">2023.04.24</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<h2 id="一实验目的-2">一、实验目的</h2>
<p>1）理解页面淘汰算法原理，编写程序演示页面淘汰算法。</p>
<p>2）验证Linux虚拟地址转化为物理地址的机制。</p>
<p>3）理解和验证缺页处理的流程。</p>
<h2 id="二实验内容-2">二、实验内容</h2>
<p>1）Windows/Linux模拟实现FIFO或LRU页面淘汰算法。</p>
<p>2）Linux下利用/proc/pid/pagemap计算某个变量或函数虚拟地址对应的物理地址等信息。建议优麒麟或麒麟系统。</p>
<p>3）研读并修改Linux内核的缺页处理函数do_no_page 或页框分配函数
get_free_page，并用printk打印调试信息。注意：需要编译内核。建议优麒麟或麒麟系统。</p>
<h2 id="三实验环境和核心代码-2">三、实验环境和核心代码</h2>
<h3 id="模拟实现fifo算法">3.1 模拟实现FIFO算法</h3>
<blockquote>
<p>开发环境：windows 11，编辑工具：vscode , 编译工具: gcc</p>
</blockquote>
<p>使用C语言模拟实现FIFO页面淘汰算法。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> num_of_command 320 <span class="comment">// 指令个数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> max_of_RAM 32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> RAM[max_of_RAM]; <span class="comment">// 内存，设：最大为32个页框</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FIFO</span><span class="params">(<span class="keyword">char</span> pages[], <span class="keyword">int</span> pagesNum, <span class="keyword">int</span> can_use)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 先清空出 can_use 个页框，不妨设前 can_use 个页框为系统分配给该程序的</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; can_use; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		RAM[i] = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 记录缺页数</span></span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 记录本次页面应填充的位置</span></span><br><span class="line">	<span class="keyword">int</span> location = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 开始执行指令（遍历页面流）</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pagesNum; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">bool</span> flag = <span class="literal">true</span>;<span class="comment">// 记录是否缺页（true:缺页，false:不缺页）</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; can_use; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (RAM[j] == pages[i])</span><br><span class="line">			&#123;</span><br><span class="line">				flag = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 缺页淘汰</span></span><br><span class="line">		<span class="keyword">if</span> (flag == <span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			count++; <span class="comment">// 缺页数 + 1</span></span><br><span class="line">			<span class="comment">// 找到了需要被淘汰的页面</span></span><br><span class="line">			RAM[location] = pages[i];</span><br><span class="line">			location = (location + <span class="number">1</span>) % can_use;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	 <span class="built_in">printf</span>(<span class="string">&quot;FIFO: 缺页次数为%3d, 缺页率为%.2f%%\n&quot;</span>, count, (<span class="keyword">float</span>)(<span class="number">100</span> * ((<span class="keyword">float</span>)count / (<span class="keyword">float</span>)pagesNum)));</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> command[num_of_command];</span><br><span class="line"><span class="keyword">char</span> pages[num_of_command];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num_of_command; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		command[i] = <span class="built_in">rand</span>() % <span class="number">260</span>;</span><br><span class="line">		pages[i] = command[i] / <span class="number">10</span> + <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> FIFO_count = <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">int</span> num_of_box = <span class="number">4</span>;</span><br><span class="line">	<span class="built_in">srand</span>((<span class="keyword">unsigned</span>)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">	<span class="keyword">while</span>(num_of_box++ &lt;= max_of_RAM)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">initialize</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Num of box: %d\t&quot;</span>, num_of_box);</span><br><span class="line">		<span class="built_in">FIFO</span>(pages, num_of_command, num_of_box);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="利用pagemap计算地址">3.2 利用pagemap计算地址</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.67，编辑工具：vim &amp;
gedit</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get Visual Address 获取虚拟地址</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_VA</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> vaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pid = <span class="built_in">getpid</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 当前pid: %d\n&quot;</span>, pid);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 虚拟地址: %lx\n&quot;</span>, vaddr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 虚拟页号: %lx\n&quot;</span>, vaddr / <span class="built_in">getpagesize</span>());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 页内偏移地址：%lx\n&quot;</span>, vaddr % <span class="built_in">getpagesize</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> v_offset = vaddr / <span class="built_in">getpagesize</span>() * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint64_t</span> item = <span class="number">0</span>; <span class="comment">// 存储对应项的值</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>) <span class="comment">// 判断是否打开失败</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open /proc/self/pagemap error\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 将游标移动到相应位置，即对应项的起始地址且判断是否移动失败</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">lseek</span>(fd, v_offset, SEEK_SET) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;sleek errer\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 读取对应项的值，并存入item中，且判断读取数据位数是否正确</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">read</span>(fd, &amp;item, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">uint64_t</span>)) != <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">uint64_t</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;read item error!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 判断当前物理页是否在内存中，</span></span><br><span class="line">	<span class="keyword">if</span> ((((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>) &amp; item) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;page present is 0\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获得物理页号，即取item的bit（0～54）</span></span><br><span class="line">	<span class="keyword">uint64_t</span> phy_pageIndex = (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>) &amp; item;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 物理页框号：%lx\n&quot;</span>, phy_pageIndex);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取物理地址</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> paddr = (phy_pageIndex * <span class="built_in">getpagesize</span>()) + vaddr % <span class="built_in">getpagesize</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 物理地址：%lx\n&quot;</span>, paddr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> a = <span class="number">100</span>; <span class="comment">// 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> b = <span class="number">100</span>;		<span class="comment">// 局部变量</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> c = <span class="number">100</span>; <span class="comment">// 局部静态变量</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> d = <span class="number">100</span>;	<span class="comment">// 局部常量</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; 页面大小：%x\n&quot;</span>, <span class="built_in">getpagesize</span>());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;全局常量:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">get_VA</span>((<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;a);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n局部变量:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">get_VA</span>((<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;b);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n全局静态变量:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">get_VA</span>((<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;c);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n局部常量:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">get_VA</span>((<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;d);</span><br><span class="line">	<span class="comment">// while (1);</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="四实验结果-2">四、实验结果</h2>
<h3 id="模拟实现fifo算法-1">4.1 模拟实现FIFO算法</h3>
<figure>
<img src="/report/os-report/image-20230427170901514.png" alt="image-20230427170901514">
<figcaption aria-hidden="true">image-20230427170901514</figcaption>
</figure>
<h3 id="利用pagemap计算地址-1">4.2 利用pagemap计算地址</h3>
<figure>
<img src="/report/os-report/2023-04-27%2017-15-36屏幕截图.png" alt="2023-04-27 17-15-36屏幕截图">
<figcaption aria-hidden="true">2023-04-27 17-15-36屏幕截图</figcaption>
</figure>
<h2 id="五实验错误排查和解决方法-2">五、实验错误排查和解决方法</h2>
<h3 id="模拟实现fifo算法-2">5.1 模拟实现FIFO算法</h3>
<h4 id="程序报错identifier-bool-is-undefined">5.1.1 程序报错：identifier
"bool" is undefined：</h4>
<p>问题出现的原因是 C 语言中没有 bool 类型 因此，需要在程序中加上头文件
#include&lt;stdbool.h&gt;。</p>
<h3 id="利用pagemap计算地址-2">5.2 利用pagemap计算地址</h3>
<h4 id="运行程序时发现物理页框号均为0">5.2.1
运行程序时发现物理页框号均为0</h4>
<p>问题出现的原因是程序的权限不够，应该在可执行文件前加上<code>sudo</code>。</p>
<h2 id="六实验参考资料和网址-2">六、实验参考资料和网址</h2>
<ul>
<li>教学课件</li>
<li>操作系统-内存管理实验指导书：https://wenku.baidu.com/view/ffd39261011ca300a6c390ee.html?re=view&amp;<em>wkts</em>=1682560478932</li>
<li>用C++实现LRU算法：
https://blog.csdn.net/z702143700/article/details/48374201</li>
<li>用C++实现FIFO算法：https://blog.csdn.net/weixin_44384477/article/details/109538424</li>
</ul>
<h1 align="center">
《操作系统原理》实验报告(四)
</h1>
<table style="width:100%;">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 18%">
<col style="width: 7%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">姓名</th>
<th style="text-align: center;">dekrt</th>
<th style="text-align: center;">学号</th>
<th style="text-align: center;">U2021172??</th>
<th style="text-align: center;">专业班级</th>
<th style="text-align: center;">软件2102班</th>
<th style="text-align: center;">时间</th>
<th style="text-align: center;">2023.05.07</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<h2 id="一实验目的-3">一、实验目的</h2>
<p>1）掌握Linux驱动概念和编程流程，理解设备是文件的概念。
2）掌握Linux下文件读写操作 3）了解索引文件系统和索引节点的概念</p>
<h2 id="二实验内容-3">二、实验内容</h2>
<p>1）编写Linux驱动程序（字符类型或杂项类型）和相应的测试程序。驱动程序的功能：(a)写入一个整数表示设备的状态；
(b)读出设备的状态；(c)输入两个整数和要做的操作的指示码（用1,2,3分别表示求和，求差，求最大值），分别返回和、差和最大值。要求使用IOCTL接口。
2）编写Linux驱动程序（字符类型或杂项类型）和相应的测试程序。测试程序的功能：使用open函数先后打开该设备和2<sub>5个文本文件（自己编造2</sub>5个文本文件）。驱动程序的功能：打印测试程序进程PCB的成员信息，越多越好，其中必须包括：内核版本，进程ID，程序名，打开的文件列表，占用内存信息等。
3）编造若干大小不等的文本文件并创建它们的软链接和硬链接，自己设计各种验证过程，感性认识inode索引节点和索引文件系统。</p>
<h2 id="三实验环境和核心代码-3">三、实验环境和核心代码</h2>
<h3 id="编写linux驱动及测试程序">3.1 编写Linux驱动及测试程序</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.71，编辑工具：vim &amp;
vscode，编译器：gcc</p>
</blockquote>
<h4 id="驱动程序代码">3.1.1 驱动程序代码：</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEV_NAME <span class="meta-string">&quot;my_dev&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGIC_NUM <span class="meta-string">&#x27;k&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_SET_ARGS _IOW(MAGIC_NUM, 1, int *)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_GET_RESULT _IOR(MAGIC_NUM, 2, int *)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dev_t</span> dev;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_dev: Device opened\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_release</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_dev: Device released\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">my_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (count != <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = copy_from_user(&amp;state, buf, count);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_dev: State set to %d\n&quot;</span>, state);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">my_read</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (count != <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = copy_to_user(buf, &amp;state, count);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_dev: State read as %d\n&quot;</span>, state);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">my_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> args[<span class="number">3</span>], ret;</span><br><span class="line">    <span class="keyword">int</span> op_code = (cmd == IOCTL_SET_ARGS) ? <span class="number">1</span> : <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_SET_ARGS:</span><br><span class="line">    <span class="keyword">case</span> IOCTL_GET_RESULT:</span><br><span class="line">        ret = copy_from_user(args, (<span class="keyword">void</span> __user *)arg, <span class="keyword">sizeof</span>(args));</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;my_dev: IOCTL cmd=%u, arg1=%d, arg2=%d, op=%d\n&quot;</span>,</span><br><span class="line">               cmd, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (op_code)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">/* perform the operation */</span></span><br><span class="line">        <span class="keyword">switch</span> (args[<span class="number">2</span>])</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">/* add */</span></span><br><span class="line">            state = args[<span class="number">0</span>] + args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">/* subtract */</span></span><br><span class="line">            state = args[<span class="number">0</span>] - args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">/* maximum */</span></span><br><span class="line">            state = (args[<span class="number">0</span>] &gt; args[<span class="number">1</span>]) ? args[<span class="number">0</span>] : args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">/* return the result */</span></span><br><span class="line">        ret = copy_to_user((<span class="keyword">void</span> __user *)arg, &amp;state, <span class="keyword">sizeof</span>(state));</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">my_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = my_open,</span><br><span class="line">    .release = my_release,</span><br><span class="line">    .write = my_write,</span><br><span class="line">    .read = my_read,</span><br><span class="line">    .unlocked_ioctl = my_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">my_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    ret = alloc_chrdev_region(&amp;dev, <span class="number">0</span>, <span class="number">1</span>, DEV_NAME);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;my_dev: Failed to allocate chrdev region\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;cdev, &amp;my_fops);</span><br><span class="line">    cdev.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    ret = cdev_add(&amp;cdev, dev, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;my_dev: Failed to add cdev\n&quot;</span>);</span><br><span class="line">        unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_dev: Initialized\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">my_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cdev_del(&amp;cdev);</span><br><span class="line">    unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_dev: Exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_exit(my_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;dekrt&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;A simple character driver for testing ioctl&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="测试程序代码">3.1.2 测试程序代码：</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEV_PATH <span class="meta-string">&quot;/dev/my_dev&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_MAGIC <span class="meta-string">&#x27;k&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_SET_ARGS _IOW(IOCTL_MAGIC, 1, int *)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_GET_RESULT _IOR(IOCTL_MAGIC, 2, int *)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, ret, args[<span class="number">3</span>], result;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt;&gt;&gt; please input num_1, num_2 and the operation number:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt;&gt;&gt; operation number: 1 for add, 2 for minus, 3 for maximize&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;args[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    fd = open(DEV_PATH, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = ioctl(fd, IOCTL_SET_ARGS, args);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl set args&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = ioctl(fd, IOCTL_GET_RESULT, &amp;result);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl get result&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Result: %d\n&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="makefile">3.1.3 Makefile</h4>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">obj-m += my_dev.o</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">	make -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(PWD)</span> modules</span><br><span class="line">	gcc -Wall -o test test.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	make -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(PWD)</span> clean</span><br><span class="line">	rm -f test</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="安装过程">3.1.4 安装过程</h4>
<p>使用<code>sudo su</code>命令进入root模式，在代码目录使用<code>make</code>命令进行编译，编译完成后使用<code>insmod my_dev.ko</code>命令安装编译好的模块：</p>
<figure>
<img src="/report/os-report/image-20230507235059842.png" alt="image-20230507235059842">
<figcaption aria-hidden="true">image-20230507235059842</figcaption>
</figure>
<p>使用<code>lsmod</code>命令，可以看到my_dev模块被成功安装。再使用<code>cat /proc/devices</code>命令查看设备调用的的设备号，可以看到<code>my_dev</code>的设备号是508</p>
<figure>
<img src="/report/os-report/image-20230507235628170.png" alt="image-20230507235628170">
<figcaption aria-hidden="true">image-20230507235628170</figcaption>
</figure>
<p>使用<code>mknod /dev/my_dev c 508 0</code>命令创建相应设备，使用<code>ll</code>命令验证设备创建成功。</p>
<figure>
<img src="/report/os-report/image-20230507235817552.png" alt="image-20230507235817552">
<figcaption aria-hidden="true">image-20230507235817552</figcaption>
</figure>
<p>运行测试程序，可以发现其成功运行</p>
<figure>
<img src="/report/os-report/image-20230508000030613.png" alt="image-20230508000030613">
<figcaption aria-hidden="true">image-20230508000030613</figcaption>
</figure>
<h3 id="linux下创建软连接与硬连接">3.2 Linux下创建软连接与硬连接</h3>
<blockquote>
<p>开发环境：Ubuntu 20.04，内核版本：5.15.71，编辑工具：vim &amp;
Vscode</p>
</blockquote>
<ol type="1">
<li>首先在命令行中创建一个名为"Test"的目录:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir Test</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>进入"Test"目录，使用以下命令创建一个名为"file1"的文件，并写入一些内容：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Test</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is file 1&quot;</span> &gt; file1</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>使用以下命令创建一个名为"hardlink1"的硬链接：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln file1 hardlink1</span><br></pre></td></tr></table></figure>
<ol start="4" type="1">
<li>以下命令创建一个名为"symlink1"的软链接：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s file1 symlink1</span><br></pre></td></tr></table></figure>
<ol start="5" type="1">
<li>用以下命令查看"file1"、"hardlink1"和"symlink1"的详细信息：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -li</span><br></pre></td></tr></table></figure>
<p>这个命令会输出包含文件索引节点号（inode）的列表，以及每个文件的权限、链接数、所有者和大小等信息。我们可以发现，"file1"、"hardlink1"和"symlink1"的inode号是一样的，说明它们都指向同一个数据块。</p>
<ol start="6" type="1">
<li>接下来，我们尝试在"file1"中添加一些内容，然后再次查看这三个文件的信息：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is some more content&quot;</span> &gt;&gt; file1</span><br><span class="line">ls -li</span><br></pre></td></tr></table></figure>
<p>现在我们会发现，三个文件的大小都增加了，并且它们的inode号仍然相同。</p>
<ol start="7" type="1">
<li>接着，我们使用以下命令创建一个名为"file2"的新文件：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is file 2&quot;</span> &gt; file2</span><br></pre></td></tr></table></figure>
<ol start="8" type="1">
<li>然后，我们使用以下命令删除"file1"：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm file1</span><br></pre></td></tr></table></figure>
<ol start="9" type="1">
<li>最后，我们再次查看"hardlink1"和"symlink1"的详细信息：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -li</span><br></pre></td></tr></table></figure>
<p>我们会发现，"hardlink1"仍然存在，而"symlink1"则已经无法找到目标文件，因为它是指向"file1"的软链接，而"file1"已经被删除了。</p>
<p>通过这个实验，我们可以感性认识索引文件和索引节点的概念。在Linux中，每个文件都有一个唯一的inode号，它包含了文件的元数据（如文件所有者、文件权限、文件大小等）以及指向数据块的指针。当我们创建一个硬链接时，实际上是在文件系统中创建了一个新的目录项，它指向相同的inode。这个新的目录项与原始文件目录项没有区别，它们是等价的。而软链接则是一个特殊的文件，它包含了指向目标文件的路径，当我们访问软链接时，实际上是通过路径找到了目标文件。</p>
<figure>
<img src="/report/os-report/image-20230508171201762.png" alt="image-20230508171201762">
<figcaption aria-hidden="true">image-20230508171201762</figcaption>
</figure>
<h2 id="四实验结果-3">四、实验结果</h2>
<h3 id="编写linux驱动及测试程序-1">4.1 编写Linux驱动及测试程序</h3>
<p>运行测试程序，可以发现其成功运行</p>
<figure>
<img src="/report/os-report/image-20230508000030613.png" alt="image-20230508000030613">
<figcaption aria-hidden="true">image-20230508000030613</figcaption>
</figure>
<h3 id="linux下创建软连接与硬连接-1">4.2 Linux下创建软连接与硬连接</h3>
<figure>
<img src="/report/os-report/image-20230508171214021.png" alt="image-20230508171214021">
<figcaption aria-hidden="true">image-20230508171214021</figcaption>
</figure>
<h2 id="五实验错误排查和解决方法-3">五、实验错误排查和解决方法</h2>
<h3 id="编写linux驱动及测试程序-2">5.1 编写Linux驱动及测试程序</h3>
<h4 id="错误1注册设备后dev-下没有对应的节点文件">错误1：注册设备后/dev
下没有对应的节点文件</h4>
<p>字符设备注册函数不会自动创建设备节点文件，需要使用 mknod
命令手动创建，或者使用相关 API
函数（⻅三）。使用杂项设备的方式来注册可以避免这个复杂的过程。</p>
<h4 id="错误2测试程序无法打开设备文件测试程序执行结果不正确">错误2：测试程序无法打开设备文件/测试程序执行结果不正确</h4>
<p>测试程序没有访问设备的权限
很多同学都会遇到这个问题。使用超级用户权限来执行测试程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ./<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h2 id="六实验参考资料和网址-3">六、实验参考资料和网址</h2>
<ul>
<li>教学课件</li>
<li>Google</li>
<li>Stackoverflow</li>
<li>CSDN</li>
</ul>
<h1 id="操作系统原理课程设计报告">操作系统原理课程设计报告</h1>
<blockquote>
<p>懒得转markdown了，直接把pdf丢上来吧，用电脑可以正常查看pdf</p>
</blockquote>


	<div class="row">
    <embed src="./os-final-report.pdf" width="100%" height="550" type="application/pdf">
	</div>



</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">dekrt</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dekrt.cn/report/os-report/">https://dekrt.cn/report/os-report/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dekrt.cn" target="_blank">dekrt's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%8A%A5%E5%91%8A-report/">报告 | report</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2023/07/26/pCjs4a9.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechatpay.png" target="_blank"><img class="post-qr-code-img" src="/img/wechatpay.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/report/se-report/"><img class="prev-cover" src="https://s1.ax1x.com/2023/07/26/pCjsWb4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">软件工程课程设计 &amp; 理论课实验报告</div></div></a></div><div class="next-post pull-right"><a href="/tutorial/maike/"><img class="next-cover" src="https://s1.ax1x.com/2023/04/14/ppzT0Vx.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">安全教育刷课教程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/report/database/" title="数据库系统原理课程设计"><img class="cover" src="https://s11.ax1x.com/2024/02/23/pFUM2md.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-22</div><div class="title">数据库系统原理课程设计</div></div></a></div><div><a href="/report/microcomputer/" title="微机原理的实验报告"><img class="cover" src="https://s11.ax1x.com/2024/02/09/pF3JFGF.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-09</div><div class="title">微机原理的实验报告</div></div></a></div><div><a href="/report/math-modeling/" title="数学建模上机实验与大作业报告"><img class="cover" src="https://s11.ax1x.com/2024/02/09/pF38iwV.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-09</div><div class="title">数学建模上机实验与大作业报告</div></div></a></div><div><a href="/report/ccd/" title="编译原理课程实验报告"><img class="cover" src="https://z1.ax1x.com/2023/12/12/pifVYB4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-12</div><div class="title">编译原理课程实验报告</div></div></a></div><div><a href="/report/se-report/" title="软件工程课程设计 & 理论课实验报告"><img class="cover" src="https://s1.ax1x.com/2023/07/26/pCjsWb4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-07-18</div><div class="title">软件工程课程设计 & 理论课实验报告</div></div></a></div><div><a href="/report/cpsd/" title="软件设计综合实践实验报告"><img class="cover" src="https://s1.ax1x.com/2023/03/14/pplXRSO.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-14</div><div class="title">软件设计综合实践实验报告</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s1.ax1x.com/2023/04/14/ppzvSxK.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">dekrt</div><div class="author-info__description">write something casually</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dekrt"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dekrt" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:dekrt@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://weibo.com/dekrt" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="https://twitter.com/dekrt2" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="https://instagram.com/dekrt" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">菜菜，呜呜，捞捞</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">
《操作系统原理》实验报告(一)
</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84"><span class="toc-number">1.1.</span> <span class="toc-text">一、实验目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9"><span class="toc-number">1.2.</span> <span class="toc-text">二、实验内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%92%8C%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.</span> <span class="toc-text">三、实验环境和核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8nasm%E7%BC%96%E5%86%99mbr%E5%BC%95%E5%AF%BC%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 用NASM编写MBR引导程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%81%E5%89%AA%E5%B9%B6%E7%BC%96%E8%AF%91linux%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 裁剪并编译linux内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BAlinux%E5%86%85%E6%A0%B8%E5%A2%9E%E6%B7%BB%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 为linux内核增添系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8linux%E4%B8%8B%E7%BC%96%E5%86%99shell%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 在linux下编写shell文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.</span> <span class="toc-text">四、实验结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8nasm%E7%BC%96%E5%86%99mbr%E5%BC%95%E5%AF%BC%E7%A8%8B%E5%BA%8F-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 用NASM编写MBR引导程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%81%E5%89%AA%E5%B9%B6%E7%BC%96%E8%AF%91linux%E5%86%85%E6%A0%B8-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 裁剪并编译linux内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BAlinux%E5%86%85%E6%A0%B8%E5%A2%9E%E6%B7%BB%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-1"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 为linux内核增添系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8linux%E4%B8%8B%E7%BC%96%E5%86%99shell%E6%96%87%E4%BB%B6-1"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 在linux下编写shell文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E5%AE%9E%E9%AA%8C%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">五、实验错误排查和解决方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8nasm%E7%BC%96%E5%86%99mbr%E5%BC%95%E5%AF%BC%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 用NASM编写MBR引导程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF1%E7%94%A8bochs--f-bochsrc%E5%90%AF%E5%8A%A8bochs%E6%97%B6%E6%8A%A5%E9%94%99reading-from-bochsrc-failed"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">错误1：用bochs
-f bochsrc启动bochs时报错reading from bochsrc failed</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF2no-bootable-device"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">错误2：No bootable device</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%81%E5%89%AA%E5%B9%B6%E7%BC%96%E8%AF%91linux%E5%86%85%E6%A0%B8-2"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 裁剪并编译linux内核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%981%E7%BC%BA%E5%B0%91%E7%BC%96%E8%AF%91%E6%89%80%E9%9C%80%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85%E6%88%96%E5%BA%93"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">问题1：缺少编译所需的软件包或库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%982%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">问题2：内核配置错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%983%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">问题3：内存不足</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%984%E6%9E%84%E5%BB%BA%E5%86%85%E6%A0%B8%E6%97%B6%E7%BC%BA%E5%B0%91%E5%BF%85%E9%9C%80%E7%9A%84%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">问题4：构建内核时缺少必需的文件或目录：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%985%E7%BC%BA%E5%B0%91%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">问题5：缺少内核模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%986%E6%B2%A1%E6%9C%89%E8%A7%84%E5%88%99%E5%8F%AF%E5%88%B6%E4%BD%9C%E7%9B%AE%E6%A0%87"><span class="toc-number">1.5.2.6.</span> <span class="toc-text">问题6：没有规则可制作目标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BAlinux%E5%86%85%E6%A0%B8%E5%A2%9E%E6%B7%BB%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-2"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 为linux内核增添系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF1%E7%BC%96%E8%AF%91%E6%97%B6%E5%87%BA%E7%8E%B0undefined__x64_sys_add"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">错误1：编译时出现undefined:__x64_sys_add</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF2%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">错误2：模块加载错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF3%E4%BF%AE%E6%94%B9%E7%BC%96%E8%AF%91%E5%90%8E%E4%BB%8D%E7%84%B6%E6%98%AF%E4%BF%AE%E6%94%B9%E5%89%8D%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">错误3：修改编译后仍然是修改前的结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8linux%E4%B8%8B%E7%BC%96%E5%86%99shell%E6%96%87%E4%BB%B6-2"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 在linux下编写shell文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF1%E8%A7%A3%E9%87%8A%E5%99%A8%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">错误1：解释器错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF2%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">错误2：权限问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF3%E8%AF%AD%E6%B3%95%E9%94%99%E8%AF%AF"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">错误3：语法错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF4%E5%8F%98%E9%87%8F%E6%9C%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">错误4：变量未定义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%AE%9E%E9%AA%8C%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%E5%92%8C%E7%BD%91%E5%9D%80"><span class="toc-number">1.6.</span> <span class="toc-text">六、实验参考资料和网址</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">
《操作系统原理》实验报告(二)
</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84-1"><span class="toc-number">2.1.</span> <span class="toc-text">一、实验目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9-1"><span class="toc-number">2.2.</span> <span class="toc-text">二、实验内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%92%8C%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-1"><span class="toc-number">2.3.</span> <span class="toc-text">三、实验环境和核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%94%A8%E7%BA%BF%E7%A8%8B%E5%88%86%E5%88%AB%E8%BE%93%E5%87%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 运用线程分别输出数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E5%AE%9E%E9%AA%8Cwaitexit%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 Linux下实验wait&#x2F;exit函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E4%B8%80"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">3.2.1 效果一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E4%BA%8C"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">3.2.2 效果二</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E5%90%8C%E6%AD%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3 “生产者-消费者”同步控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90"><span class="toc-number">2.3.4.</span> <span class="toc-text">3.4 模拟哲学家就餐</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E4%BA%A7%E7%94%9F%E6%AD%BB%E9%94%81"><span class="toc-number">2.3.4.1.</span> <span class="toc-text">3.4.1 可能产生死锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E4%BC%9A%E4%BA%A7%E7%94%9F%E6%AD%BB%E9%94%81"><span class="toc-number">2.3.4.2.</span> <span class="toc-text">3.4.2 不会产生死锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E8%B0%83%E7%94%A8printk%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="toc-number">2.3.5.</span> <span class="toc-text">3.5
Linux下调用printk查看进程信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C-1"><span class="toc-number">2.4.</span> <span class="toc-text">四、实验结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%94%A8%E7%BA%BF%E7%A8%8B%E5%88%86%E5%88%AB%E8%BE%93%E5%87%BA%E6%95%B0%E6%8D%AE-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 运用线程分别输出数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E5%AE%9E%E9%AA%8Cwaitexit%E5%87%BD%E6%95%B0-1"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 Linux下实验wait&#x2F;exit函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E4%B8%80-1"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">4.2.1 效果一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E4%BA%8C-1"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">4.2.2 效果二</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E5%90%8C%E6%AD%A5%E6%8E%A7%E5%88%B6-1"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.3 “生产者-消费者”同步控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8linux%E4%B8%8B%E7%BC%96%E5%86%99shell%E6%96%87%E4%BB%B6-3"><span class="toc-number">2.4.4.</span> <span class="toc-text">4.4 在linux下编写shell文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%BB%E9%94%81%E8%A7%A3%E6%B3%95"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">4.4.1 死锁解法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E6%AD%BB%E9%94%81%E8%A7%A3%E6%B3%95"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">4.4.2 非死锁解法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E8%B0%83%E7%94%A8printk%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF-1"><span class="toc-number">2.4.5.</span> <span class="toc-text">4.5
Linux下调用printk查看进程信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E5%AE%9E%E9%AA%8C%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-1"><span class="toc-number">2.5.</span> <span class="toc-text">五、实验错误排查和解决方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#error-cast-from-lpvoid-aka-void-to-int-loses-precision--fpermissive"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1
[Error] cast from &#39;LPVOID {aka void*}&#39; to &#39;int&#39; loses precision
[-fpermissive]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E7%94%A8printk%E8%BE%93%E5%87%BA%E4%BF%A1%E6%81%AF"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2 Linux下用printk输出信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%AE%9E%E9%AA%8C%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%E5%92%8C%E7%BD%91%E5%9D%80-1"><span class="toc-number">2.6.</span> <span class="toc-text">六、实验参考资料和网址</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">
《操作系统原理》实验报告(三)
</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84-2"><span class="toc-number">3.1.</span> <span class="toc-text">一、实验目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9-2"><span class="toc-number">3.2.</span> <span class="toc-text">二、实验内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%92%8C%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-2"><span class="toc-number">3.3.</span> <span class="toc-text">三、实验环境和核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0fifo%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1 模拟实现FIFO算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8pagemap%E8%AE%A1%E7%AE%97%E5%9C%B0%E5%9D%80"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2 利用pagemap计算地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C-2"><span class="toc-number">3.4.</span> <span class="toc-text">四、实验结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0fifo%E7%AE%97%E6%B3%95-1"><span class="toc-number">3.4.1.</span> <span class="toc-text">4.1 模拟实现FIFO算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8pagemap%E8%AE%A1%E7%AE%97%E5%9C%B0%E5%9D%80-1"><span class="toc-number">3.4.2.</span> <span class="toc-text">4.2 利用pagemap计算地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E5%AE%9E%E9%AA%8C%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-2"><span class="toc-number">3.5.</span> <span class="toc-text">五、实验错误排查和解决方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0fifo%E7%AE%97%E6%B3%95-2"><span class="toc-number">3.5.1.</span> <span class="toc-text">5.1 模拟实现FIFO算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%8A%A5%E9%94%99identifier-bool-is-undefined"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">5.1.1 程序报错：identifier
&quot;bool&quot; is undefined：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8pagemap%E8%AE%A1%E7%AE%97%E5%9C%B0%E5%9D%80-2"><span class="toc-number">3.5.2.</span> <span class="toc-text">5.2 利用pagemap计算地址</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F%E6%97%B6%E5%8F%91%E7%8E%B0%E7%89%A9%E7%90%86%E9%A1%B5%E6%A1%86%E5%8F%B7%E5%9D%87%E4%B8%BA0"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">5.2.1
运行程序时发现物理页框号均为0</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%AE%9E%E9%AA%8C%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%E5%92%8C%E7%BD%91%E5%9D%80-2"><span class="toc-number">3.6.</span> <span class="toc-text">六、实验参考资料和网址</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">
《操作系统原理》实验报告(四)
</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84-3"><span class="toc-number">4.1.</span> <span class="toc-text">一、实验目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E5%AE%9E%E9%AA%8C%E5%86%85%E5%AE%B9-3"><span class="toc-number">4.2.</span> <span class="toc-text">二、实验内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%92%8C%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81-3"><span class="toc-number">4.3.</span> <span class="toc-text">三、实验环境和核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99linux%E9%A9%B1%E5%8A%A8%E5%8F%8A%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.1 编写Linux驱动及测试程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">3.1.1 驱动程序代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">3.1.2 测试程序代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#makefile"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">3.1.3 Makefile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B"><span class="toc-number">4.3.1.4.</span> <span class="toc-text">3.1.4 安装过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E5%88%9B%E5%BB%BA%E8%BD%AF%E8%BF%9E%E6%8E%A5%E4%B8%8E%E7%A1%AC%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.2 Linux下创建软连接与硬连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C-3"><span class="toc-number">4.4.</span> <span class="toc-text">四、实验结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99linux%E9%A9%B1%E5%8A%A8%E5%8F%8A%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F-1"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.1 编写Linux驱动及测试程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#linux%E4%B8%8B%E5%88%9B%E5%BB%BA%E8%BD%AF%E8%BF%9E%E6%8E%A5%E4%B8%8E%E7%A1%AC%E8%BF%9E%E6%8E%A5-1"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.2 Linux下创建软连接与硬连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E5%AE%9E%E9%AA%8C%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95-3"><span class="toc-number">4.5.</span> <span class="toc-text">五、实验错误排查和解决方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99linux%E9%A9%B1%E5%8A%A8%E5%8F%8A%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F-2"><span class="toc-number">4.5.1.</span> <span class="toc-text">5.1 编写Linux驱动及测试程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF1%E6%B3%A8%E5%86%8C%E8%AE%BE%E5%A4%87%E5%90%8Edev-%E4%B8%8B%E6%B2%A1%E6%9C%89%E5%AF%B9%E5%BA%94%E7%9A%84%E8%8A%82%E7%82%B9%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.1.1.</span> <span class="toc-text">错误1：注册设备后&#x2F;dev
下没有对应的节点文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF2%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%E4%B8%8D%E6%AD%A3%E7%A1%AE"><span class="toc-number">4.5.1.2.</span> <span class="toc-text">错误2：测试程序无法打开设备文件&#x2F;测试程序执行结果不正确</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%AE%9E%E9%AA%8C%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%E5%92%8C%E7%BD%91%E5%9D%80-3"><span class="toc-number">4.6.</span> <span class="toc-text">六、实验参考资料和网址</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86%E8%AF%BE%E7%A8%8B%E8%AE%BE%E8%AE%A1%E6%8A%A5%E5%91%8A"><span class="toc-number">5.</span> <span class="toc-text">操作系统原理课程设计报告</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/report/database/" title="数据库系统原理课程设计"><img src="https://s11.ax1x.com/2024/02/23/pFUM2md.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据库系统原理课程设计"/></a><div class="content"><a class="title" href="/report/database/" title="数据库系统原理课程设计">数据库系统原理课程设计</a><time datetime="2024-02-22T06:02:42.000Z" title="发表于 2024-02-22 14:02:42">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/report/microcomputer/" title="微机原理的实验报告"><img src="https://s11.ax1x.com/2024/02/09/pF3JFGF.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="微机原理的实验报告"/></a><div class="content"><a class="title" href="/report/microcomputer/" title="微机原理的实验报告">微机原理的实验报告</a><time datetime="2024-02-09T08:59:46.000Z" title="发表于 2024-02-09 16:59:46">2024-02-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/report/math-modeling/" title="数学建模上机实验与大作业报告"><img src="https://s11.ax1x.com/2024/02/09/pF38iwV.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数学建模上机实验与大作业报告"/></a><div class="content"><a class="title" href="/report/math-modeling/" title="数学建模上机实验与大作业报告">数学建模上机实验与大作业报告</a><time datetime="2024-02-09T07:41:13.000Z" title="发表于 2024-02-09 15:41:13">2024-02-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/report/ccd/" title="编译原理课程实验报告"><img src="https://z1.ax1x.com/2023/12/12/pifVYB4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="编译原理课程实验报告"/></a><div class="content"><a class="title" href="/report/ccd/" title="编译原理课程实验报告">编译原理课程实验报告</a><time datetime="2023-12-12T12:09:46.000Z" title="发表于 2023-12-12 20:09:46">2023-12-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/report/se-report/" title="软件工程课程设计 &amp; 理论课实验报告"><img src="https://s1.ax1x.com/2023/07/26/pCjsWb4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="软件工程课程设计 &amp; 理论课实验报告"/></a><div class="content"><a class="title" href="/report/se-report/" title="软件工程课程设计 &amp; 理论课实验报告">软件工程课程设计 &amp; 理论课实验报告</a><time datetime="2023-07-18T03:09:40.000Z" title="发表于 2023-07-18 11:09:40">2023-07-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s1.ax1x.com/2023/07/26/pCjs4a9.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By dekrt</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你是宇宙中恰好相遇的浪漫</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '919vOTDx94zr39dk7GN8V5oO-gzGzoHsz',
      appKey: 'SNQo190ERObk522PearaqLyG',
      avatar: 'mp',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>